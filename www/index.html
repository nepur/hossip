<!DOCTYPE html>
<html>
    <head>
        <title>Apigee based App</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.css" />
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.js"></script>
        <script src="http://raw.github.com/apigee/usergrid-javascript-sdk/master/usergrid.min.js"></script>
        
        <script type="text/javascript" src="cordova-2.6.0.js"></script>
            
        <script type="text/javascript">
        
            var apigee = new Usergrid.Client({
                orgName:'rupenp',
                appName:'sandbox'
            });

            
            $(document).ready(function () {
                // A Collection object that will be used to hold the list of books locally
                var my_books;// = new Usergrid.Collection( { "client":apigee, "type":"books" } );
                var globalPosition;
                $('#create-button').bind('click', createBook);
                              
                navigator.geolocation.getCurrentPosition(onSuccess, onError);
                              
                // onSuccess Geolocation
                function onSuccess(position) {
                  alert("Success "+ position.coords.latitude + "," + position.coords.longitude);
                  globalPosition = position;
                  //my_books = new Usergrid.Collection( { "client":apigee, "type":"books", "qs":{"limit":50, "ql":"order by created desc"} } );
                              
                  my_books = new Usergrid.Collection( { "client":apigee, "type":"books", "qs":{"limit":50, "ql":"select *"} } );

                  refreshFeed();
                              
                  //var geostring = 'Latitude: ' + position.coords.latitude + '<br />' +
                  //'Longitude: '          + position.coords.longitude             + '<br />' +
                  //'Altitude: '           + position.coords.altitude              + '<br />' +
                  //'Accuracy: '           + position.coords.accuracy              + '<br />' +
                  //'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
                  //'Heading: '            + position.coords.heading               + '<br />' +
                  //'Speed: '              + position.coords.speed                 + '<br />' +
                  //'Timestamp: '          +                                   position.timestamp          + '<br />';
                  //alert(geostring);
                }
              
                // onError Callback receives a PositionError object
                function onError(error) {
                 alert('code: '    + error.code    + '\n' +
                    'message: ' + error.message + '\n');
                }
                
                function refreshFeed() {
                    // Actual network call
                    my_books.fetch(
                        // Success Callback
                        function () {
                            $('#books-list').empty();
                            
                            while ( my_books.hasNextEntity() ) {
                                var current_book = my_books.getNextEntity();

                                // Output the book on the page
                                $('#books-list').append('<li><h3>'+current_book.get('title')+'</h3><p>'+current_book.get('author')+'</p></li>');
                            }
                            // Re-apply jQuery Mobile styles
                            $('#books-list').listview('refresh');
                        },

                        // Failure Callback
                        function () { alert("read failed"); }
                    );
                }

                function createBook() {
                    new_book = { "title":$("#title-field").val(),
                                "author":$("#author-field").val() };

                    my_books.addEntity(new_book, function (error, response) {
                        if (error) {
                            alert('write failed');
                        } else {
                            $("#title-field").val(""), $("#author-field").val("");
                            refreshFeed();
							//This might not work in older browser
                            //history.back();
							$('#page-new-book').dialog('close');
                        }
                    });
                }
            });
        </script>
    </head>
    <body>

        <div data-role="page" data-theme="c" id="page-books-list">
            <div data-role="header" data-theme="b" data-position="fixed">
                <h1>My Books</h1>
                <a href="#page-new-book" id="btn-compose" data-icon="plus" data-iconpos="right" data-inline="true" data-role="button" data-rel="dialog" data-transition="fade" class="ui-btn-right">Add</a>
            </div>
            <div data-role="content">
                <ul id="books-list"  data-role="listview" data-inset="false" >
                    <li>
                        <h3>First Title</h3>
                        <p>First author</p>
                    </li>
                    <li>
                        <h3>Second Title</h3>
                        <p>Second author</p>
                    </li>
                </ul>
            </div>
        </div>


        <div data-role="page" data-theme="b" id="page-new-book">
            <div data-role="header" data-theme="b" data-position="fixed">
                <h1>Add a New Book</h1>
            </div>
            <div data-role="content">
                <form>
                    <label for="title-field">Title</label>
                    <textarea id="title-field"></textarea>
                    <label for="author-field">Author</label>
                    <textarea id="author-field"></textarea>
                </form>    
                <a data-rel="back" data-role="button" data-theme="c" data-inline="true">Cancel</a>
                <button id="create-button" data-inline="true">Create</button>
            </div>
        </div>

    </body>
</html>